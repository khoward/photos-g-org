<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Photos Organizer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <main class="container">
        <header class="glass-header">
            <h1>Google Photos Organizer</h1>
        </header>

        <!-- Credentials Card -->
        <article class="glass-card" id="credentials-card">
            <header>
                <h3>Credentials</h3>
                <span class="status-badge" id="creds-status">Checking...</span>
            </header>
            <div class="card-content">
                <label for="creds-path">Service Account JSON Path</label>
                <input type="text" id="creds-path" placeholder="~/.config/gporg/service-account.json">
                <button class="secondary" onclick="saveCredentials()">Save Credentials</button>
            </div>
        </article>

        <!-- Filter Card -->
        <article class="glass-card">
            <header>
                <h3>Filters</h3>
            </header>
            <div class="card-content">
                <!-- Date Filter Mode Toggle -->
                <fieldset>
                    <legend>Date Filter Mode</legend>
                    <label>
                        <input type="radio" name="date-mode" value="year" checked onchange="toggleDateMode()">
                        Filter by Year
                    </label>
                    <label>
                        <input type="radio" name="date-mode" value="range" onchange="toggleDateMode()">
                        Filter by Date Range
                    </label>
                </fieldset>

                <!-- Year Selection -->
                <div id="year-filter-section">
                    <label for="year-select">Year</label>
                    <select id="year-select">
                        <option value="">Select year...</option>
                    </select>
                </div>

                <!-- Date Range Selection -->
                <div id="date-range-section" class="hidden">
                    <div class="grid">
                        <div>
                            <label for="start-date">Start Date</label>
                            <input type="date" id="start-date">
                        </div>
                        <div>
                            <label for="end-date">End Date</label>
                            <input type="date" id="end-date">
                        </div>
                    </div>
                </div>

                <hr>

                <!-- Media Type Filter -->
                <label for="media-type">Media Type</label>
                <select id="media-type">
                    <option value="ALL">All Media</option>
                    <option value="PHOTO">Photos Only</option>
                    <option value="VIDEO">Videos Only</option>
                </select>

                <!-- Content Categories -->
                <details>
                    <summary>Content Categories (optional)</summary>
                    <div id="categories-list" class="categories-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </details>

                <!-- Favorites Filter -->
                <label>
                    <input type="checkbox" id="favorites-only">
                    Favorites only
                </label>
            </div>
        </article>

        <!-- Album Card -->
        <article class="glass-card">
            <header>
                <h3>Destination Album</h3>
            </header>
            <div class="card-content">
                <fieldset>
                    <label>
                        <input type="radio" name="album-mode" value="new" checked onchange="toggleAlbumMode()">
                        Create new album
                    </label>
                    <label>
                        <input type="radio" name="album-mode" value="existing" onchange="toggleAlbumMode()">
                        Use existing album
                    </label>
                </fieldset>

                <div id="new-album-section">
                    <label for="new-album-name">Album Name</label>
                    <input type="text" id="new-album-name" placeholder="Photos from 2023">
                </div>

                <div id="existing-album-section" class="hidden">
                    <label for="existing-album">Select Album</label>
                    <select id="existing-album">
                        <option value="">Loading albums...</option>
                    </select>
                    <button class="secondary outline" onclick="loadAlbums()">Refresh</button>
                </div>
            </div>
        </article>

        <!-- Options Card -->
        <article class="glass-card">
            <header>
                <h3>Options</h3>
            </header>
            <div class="card-content">
                <label>
                    <input type="checkbox" id="skip-existing" checked>
                    Skip photos already in album
                </label>
            </div>
        </article>

        <!-- Action Button -->
        <button class="primary big-button" id="organize-btn" onclick="startOrganize()">
            Organize Photos
        </button>

        <!-- Progress Card -->
        <article class="glass-card" id="progress-card">
            <header>
                <h3>Progress</h3>
            </header>
            <div class="card-content">
                <progress id="progress-bar" value="0" max="100"></progress>
                <p id="progress-text" class="progress-status">Ready</p>
            </div>
        </article>
    </main>

    <script>
        // API Key management
        let apiKey = localStorage.getItem('gporg_api_key');

        // Filter options (populated from server)
        let filterOptions = { media_types: [], categories: [], years: [] };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', async () => {
            await ensureApiKey();
            checkConfig();
            loadFilterOptions();
            loadAlbums();
        });

        // Ensure we have an API key
        async function ensureApiKey() {
            if (apiKey) return true;

            // Try to get key from server (only works from localhost)
            try {
                const response = await fetch('/api/key');
                if (response.ok) {
                    const data = await response.json();
                    apiKey = data.api_key;
                    localStorage.setItem('gporg_api_key', apiKey);
                    return true;
                } else if (response.status === 403) {
                    // Not localhost, need to prompt for key
                    promptForApiKey();
                    return false;
                }
            } catch (e) {
                console.error('Error getting API key:', e);
                promptForApiKey();
                return false;
            }
            return false;
        }

        // Prompt user for API key
        function promptForApiKey() {
            const key = prompt('Enter API Key (shown when server starts):');
            if (key) {
                apiKey = key;
                localStorage.setItem('gporg_api_key', apiKey);
                location.reload();
            }
        }

        // Make authenticated fetch request
        async function authFetch(url, options = {}) {
            if (!apiKey) {
                await ensureApiKey();
            }

            const headers = options.headers || {};
            headers['X-API-Key'] = apiKey;

            const response = await fetch(url, { ...options, headers });

            // If unauthorized, clear key and prompt
            if (response.status === 401) {
                localStorage.removeItem('gporg_api_key');
                apiKey = null;
                promptForApiKey();
                throw new Error('Invalid API key');
            }

            return response;
        }

        // Check credentials configuration
        async function checkConfig() {
            try {
                const response = await authFetch('/api/config');
                const data = await response.json();

                const statusBadge = document.getElementById('creds-status');
                const credsPath = document.getElementById('creds-path');

                if (data.configured) {
                    statusBadge.textContent = 'Configured';
                    statusBadge.className = 'status-badge success';
                    credsPath.value = data.credentials_file || '';
                } else {
                    statusBadge.textContent = 'Not Configured';
                    statusBadge.className = 'status-badge error';
                }
            } catch (e) {
                console.error('Error checking config:', e);
            }
        }

        // Save credentials path
        async function saveCredentials() {
            const path = document.getElementById('creds-path').value;
            if (!path) {
                alert('Please enter a credentials path');
                return;
            }

            try {
                const response = await authFetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ credentials_path: path })
                });

                const data = await response.json();
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    checkConfig();
                    loadAlbums();
                }
            } catch (e) {
                alert('Error saving credentials: ' + e.message);
            }
        }

        // Load filter options (years, media types, categories)
        async function loadFilterOptions() {
            try {
                const response = await fetch('/api/filter-options');
                filterOptions = await response.json();

                // Populate year select
                const yearSelect = document.getElementById('year-select');
                yearSelect.innerHTML = '<option value="">Select year...</option>';
                for (const year of filterOptions.years) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                }

                // Populate categories checkboxes
                const categoriesList = document.getElementById('categories-list');
                categoriesList.innerHTML = '';
                for (const category of filterOptions.categories) {
                    if (category === 'NONE') continue; // Skip NONE
                    const label = document.createElement('label');
                    label.innerHTML = `
                        <input type="checkbox" name="category" value="${category}">
                        ${category.charAt(0) + category.slice(1).toLowerCase()}
                    `;
                    categoriesList.appendChild(label);
                }
            } catch (e) {
                console.error('Error loading filter options:', e);
            }
        }

        // Toggle date filter mode (year vs date range)
        function toggleDateMode() {
            const mode = document.querySelector('input[name="date-mode"]:checked').value;
            document.getElementById('year-filter-section').classList.toggle('hidden', mode !== 'year');
            document.getElementById('date-range-section').classList.toggle('hidden', mode !== 'range');
        }

        // Load albums list
        async function loadAlbums() {
            const select = document.getElementById('existing-album');
            select.innerHTML = '<option value="">Loading...</option>';

            try {
                const response = await authFetch('/api/albums');
                const data = await response.json();

                if (data.error) {
                    select.innerHTML = '<option value="">Error loading albums</option>';
                    return;
                }

                select.innerHTML = '<option value="">Select album...</option>';
                for (const album of data.albums) {
                    const option = document.createElement('option');
                    option.value = album.id;
                    option.textContent = album.title;
                    select.appendChild(option);
                }
            } catch (e) {
                select.innerHTML = '<option value="">Error loading albums</option>';
            }
        }

        // Toggle album mode (new vs existing)
        function toggleAlbumMode() {
            const mode = document.querySelector('input[name="album-mode"]:checked').value;
            document.getElementById('new-album-section').classList.toggle('hidden', mode !== 'new');
            document.getElementById('existing-album-section').classList.toggle('hidden', mode !== 'existing');
        }

        // Get selected categories
        function getSelectedCategories() {
            const checkboxes = document.querySelectorAll('input[name="category"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // Build filter description for album name suggestion
        function buildFilterDescription() {
            const dateMode = document.querySelector('input[name="date-mode"]:checked').value;
            let desc = '';

            if (dateMode === 'year') {
                const year = document.getElementById('year-select').value;
                desc = year ? `Photos from ${year}` : 'Photos';
            } else {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                if (startDate && endDate) {
                    desc = `Photos ${startDate} to ${endDate}`;
                } else if (startDate) {
                    desc = `Photos from ${startDate}`;
                } else if (endDate) {
                    desc = `Photos until ${endDate}`;
                } else {
                    desc = 'Photos';
                }
            }

            const mediaType = document.getElementById('media-type').value;
            if (mediaType === 'PHOTO') desc = desc.replace('Photos', 'Photos');
            else if (mediaType === 'VIDEO') desc = desc.replace('Photos', 'Videos');

            const categories = getSelectedCategories();
            if (categories.length > 0 && categories.length <= 2) {
                desc += ' - ' + categories.map(c => c.charAt(0) + c.slice(1).toLowerCase()).join(', ');
            }

            if (document.getElementById('favorites-only').checked) {
                desc += ' (Favorites)';
            }

            return desc;
        }

        // Start organization
        async function startOrganize() {
            const dateMode = document.querySelector('input[name="date-mode"]:checked').value;

            // Build request body
            const requestBody = {
                skip_existing: document.getElementById('skip-existing').checked
            };

            // Date filters
            if (dateMode === 'year') {
                const year = document.getElementById('year-select').value;
                if (!year) {
                    alert('Please select a year');
                    return;
                }
                requestBody.year = parseInt(year);
            } else {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                if (!startDate && !endDate) {
                    alert('Please select at least a start or end date');
                    return;
                }
                if (startDate) requestBody.start_date = startDate;
                if (endDate) requestBody.end_date = endDate;
            }

            // Media type filter
            const mediaType = document.getElementById('media-type').value;
            if (mediaType !== 'ALL') {
                requestBody.media_type = mediaType;
            }

            // Categories filter
            const categories = getSelectedCategories();
            if (categories.length > 0) {
                requestBody.categories = categories;
            }

            // Favorites filter
            if (document.getElementById('favorites-only').checked) {
                requestBody.favorites_only = true;
            }

            // Album options
            const albumMode = document.querySelector('input[name="album-mode"]:checked').value;
            if (albumMode === 'new') {
                requestBody.album_name = document.getElementById('new-album-name').value || buildFilterDescription();
            } else {
                requestBody.album_id = document.getElementById('existing-album').value;
                if (!requestBody.album_id) {
                    alert('Please select an album');
                    return;
                }
            }

            // Disable button
            const btn = document.getElementById('organize-btn');
            btn.disabled = true;
            btn.textContent = 'Organizing...';

            try {
                const response = await authFetch('/api/organize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                if (data.error) {
                    alert('Error: ' + data.error);
                    btn.disabled = false;
                    btn.textContent = 'Organize Photos';
                    return;
                }

                // Start polling for status
                pollStatus();
            } catch (e) {
                alert('Error: ' + e.message);
                btn.disabled = false;
                btn.textContent = 'Organize Photos';
            }
        }

        // Poll for organization status
        let pollInterval = null;

        async function pollStatus() {
            if (pollInterval) clearInterval(pollInterval);

            pollInterval = setInterval(async () => {
                try {
                    const response = await authFetch('/api/status');
                    const data = await response.json();

                    const progressBar = document.getElementById('progress-bar');
                    const progressText = document.getElementById('progress-text');

                    if (data.total > 0) {
                        progressBar.max = data.total;
                        progressBar.value = data.progress;
                    }
                    progressText.textContent = data.message;

                    if (!data.running) {
                        clearInterval(pollInterval);
                        pollInterval = null;

                        const btn = document.getElementById('organize-btn');
                        btn.disabled = false;
                        btn.textContent = 'Organize Photos';

                        if (data.error) {
                            progressText.classList.add('error');
                        } else {
                            progressText.classList.remove('error');
                        }
                    }
                } catch (e) {
                    console.error('Error polling status:', e);
                }
            }, 500);
        }
    </script>
</body>
</html>
